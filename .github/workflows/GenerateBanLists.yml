name: Generate Ban Lists

on:
  schedule:
    - cron: '0 */2 * * *'  # 每12小时运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  generate-lists:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Update ClickHouse repository key
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754
    - name: Add ClickHouse repository
      run: |
        echo "deb https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
    - name: Update package lists
      run: sudo apt-get update

    - name: Install ClickHouse client and network tools
      run: sudo apt-get install -y clickhouse-client iputils-ping traceroute

    - name: Tailscale
      uses: tailscale/github-action@v2
      with:
        authkey: ${{ secrets.TS_AUTH_KEY }}

    - name: Network Diagnostics
      env:
        CH_HOST: ${{ secrets.CH_HOST }}
      run: |
        sudo tailscale up
        cat ~/tailscaled.log
        echo "Pinging ClickHouse host..."
        ping -c 4 $CH_HOST
        echo "Traceroute to ClickHouse host..."
        traceroute $CH_HOST

    - name: Run SQL query and generate lists
      env:
        CH_HOST: ${{ secrets.CH_HOST }}
        CH_PORT: ${{ secrets.CH_PORT }}
        CH_DATABASE: ${{ secrets.CH_DATABASE }}
      run: |
        mkdir -p ~/AutoGeneratedList
        
        echo "Attempting to connect to ClickHouse..."
        clickhouse-client --host=$CH_HOST --port=$CH_PORT --database=$CH_DATABASE --query="SELECT 1" --format Pretty
        
        echo "Running main query..."
        clickhouse-client --host=$CH_HOST --port=$CH_PORT --database=$CH_DATABASE --query="$(cat ./tools/banned.sql)" --format CSVWithNames > ~/AutoGeneratedList/all_results.csv
        
        awk -F',' 'NR>1 {print > ("~/AutoGeneratedList/" $11 ".csv")}' ~/AutoGeneratedList/all_results.csv
        awk -F',' 'NR>1 {print $3 > ("~/AutoGeneratedList/" $11 ".txt")}' ~/AutoGeneratedList/all_results.csv
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ~/AutoGeneratedList
        git commit -m "Update ban lists" -a || echo "No changes to commit"
        git push
